---
phase: 03-opencode-adapter-multi-platform-installation
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/platform/adapters/opencode.ts
  - src/platform/index.ts
autonomous: true

must_haves:
  truths:
    - "OpenCodeAdapter implements PlatformAdapter interface"
    - "OpenCodeAdapter can read JSONC config files"
    - "OpenCodeAdapter can write JSON config files"
    - "Unimplemented methods throw clear Phase N error messages"
  artifacts:
    - path: "src/platform/adapters/opencode.ts"
      provides: "OpenCode platform adapter"
      min_lines: 100
      exports: ["OpenCodeAdapter"]
    - path: "src/platform/index.ts"
      provides: "Re-exports OpenCodeAdapter"
      contains: "OpenCodeAdapter"
  key_links:
    - from: "src/platform/adapters/opencode.ts"
      to: "src/platform/paths.ts"
      via: "OpenCodePaths import"
      pattern: "import.*OpenCodePaths.*from"
    - from: "src/platform/adapters/opencode.ts"
      to: "jsonc-parser"
      via: "parse import"
      pattern: "import.*parse.*from.*jsonc-parser"
---

<objective>
Create OpenCodeAdapter mirroring ClaudeCodeAdapter's ultra-minimal Phase 2 pattern

Purpose: Implements PLAT-05 requirement. OpenCode adapter provides platform-specific paths, config read/write (JSONC), and capability detection. Agent spawning and hooks deferred to Phase 4/5.

Output: New OpenCodeAdapter class implementing PlatformAdapter interface
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-opencode-adapter-multi-platform-installation/03-RESEARCH.md
@src/platform/adapters/claude-code.ts (reference implementation)
@src/platform/adapter.ts (interface contract)
@src/platform/paths.ts (OpenCodePaths)

Key patterns from ClaudeCodeAdapter:
- Ultra-minimal: only implement what Phase 3 needs
- Stub everything else with clear "Phase N" error messages
- Delegate path methods to OpenCodePaths
- Simple config read/write (no deep merge, no backup - install.js handles that)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create OpenCodeAdapter implementation</name>
  <files>src/platform/adapters/opencode.ts</files>
  <action>
Create new file `src/platform/adapters/opencode.ts` following ClaudeCodeAdapter pattern:

```typescript
/**
 * OpenCode Platform Adapter (Phase 3 - Ultra-minimal implementation)
 *
 * Implements ONLY what Phase 3 needs:
 * - Path methods (delegated to OpenCodePaths)
 * - Basic config read/write (JSONC parse, JSON write)
 * - Capability detection (returns false for unsupported features)
 *
 * Everything else stubbed with "Not implemented in Phase 3" errors.
 */

import * as fs from 'fs';
import * as path from 'path';
import { parse } from 'jsonc-parser';
import { PlatformAdapter, AgentInstance, HookType } from '../adapter';
import { OpenCodePaths } from '../paths';
import { PlatformType } from '../types';

export class OpenCodeAdapter implements PlatformAdapter {
  readonly name: PlatformType = 'opencode';
  readonly version: string = '1.0.0';

  private paths: OpenCodePaths;

  constructor() {
    this.paths = new OpenCodePaths();
  }

  // =========================================================================
  // Path methods - Pure delegation to OpenCodePaths
  // =========================================================================

  getConfigDir(): string {
    return this.paths.getConfigDir();
  }

  getCommandsDir(): string {
    return this.paths.getCommandsDir();
  }

  getAgentsDir(): string {
    return this.paths.getAgentsDir();
  }

  getHooksDir(): string {
    return this.paths.getHooksDir();
  }

  // =========================================================================
  // Config read/write - JSONC parse, JSON write
  // =========================================================================

  /**
   * Read OpenCode config (opencode.json or opencode.jsonc)
   *
   * Uses jsonc-parser to handle JSON with comments.
   * Returns empty object if file doesn't exist.
   */
  async readConfig(): Promise<Record<string, any>> {
    const configDir = this.getConfigDir();

    // Try both .json and .jsonc extensions
    const jsonPath = path.join(configDir, 'opencode.json');
    const jsoncPath = path.join(configDir, 'opencode.jsonc');

    let configPath = jsonPath;
    if (!fs.existsSync(jsonPath) && fs.existsSync(jsoncPath)) {
      configPath = jsoncPath;
    }

    if (!fs.existsSync(configPath)) {
      return {};
    }

    const content = fs.readFileSync(configPath, 'utf8');
    return parse(content); // jsonc-parser handles comments
  }

  /**
   * Write OpenCode config (always as JSON, not JSONC)
   *
   * GSD-generated config doesn't need comments.
   * Simple replacement - install.js handles backup.
   */
  async writeConfig(config: Record<string, any>): Promise<void> {
    const configDir = this.getConfigDir();
    const configPath = path.join(configDir, 'opencode.json');

    // Ensure directory exists
    fs.mkdirSync(configDir, { recursive: true });

    fs.writeFileSync(configPath, JSON.stringify(config, null, 2) + '\n');
  }

  /**
   * Merge updates into existing configuration
   *
   * Simple shallow merge - NOT deep merge (Phase 4).
   */
  async mergeConfig(updates: Record<string, any>): Promise<void> {
    const existing = await this.readConfig();
    const merged = { ...existing, ...updates };
    await this.writeConfig(merged);
  }

  // =========================================================================
  // Hook registration - Stubbed for Phase 5
  // =========================================================================

  async registerHook(hookType: HookType, hookPath: string): Promise<void> {
    throw new Error(`registerHook() not implemented in Phase 3 - deferred to Phase 5 (Lifecycle Hooks)`);
  }

  async unregisterHook(hookType: HookType): Promise<void> {
    throw new Error(`unregisterHook() not implemented in Phase 3 - deferred to Phase 5 (Lifecycle Hooks)`);
  }

  // =========================================================================
  // Platform capabilities - OpenCode capabilities TBD
  // =========================================================================

  supportsParallelAgents(): boolean {
    // To be determined in Phase 4 (Agent Spawning)
    return false;
  }

  supportsStatusLine(): boolean {
    // OpenCode may not have equivalent - graceful degradation
    return false;
  }

  supportsHooks(): boolean {
    // To be determined in Phase 5 (Lifecycle Hooks)
    return false;
  }

  // =========================================================================
  // Stubbed methods - Phase 4 implementation
  // =========================================================================

  async registerCommand(commandPath: string): Promise<void> {
    throw new Error('registerCommand() not implemented in Phase 3 - install.js handles command copying');
  }

  async unregisterCommand(commandName: string): Promise<void> {
    throw new Error('unregisterCommand() not implemented in Phase 3');
  }

  async spawnAgent(agentPath: string, args?: Record<string, string>): Promise<AgentInstance> {
    throw new Error('spawnAgent() not implemented in Phase 3 - deferred to Phase 4 (Agent Spawning)');
  }
}
```

Key differences from ClaudeCodeAdapter:
1. Uses jsonc-parser for config reading (handles comments)
2. Tries both .json and .jsonc extensions
3. Returns false for all capability checks (TBD in later phases)
4. Clear error messages referencing correct future phases
  </action>
  <verify>
Run: `npm run build`
Expect: TypeScript compiles without errors
  </verify>
  <done>OpenCodeAdapter created at src/platform/adapters/opencode.ts, implements PlatformAdapter interface</done>
</task>

<task type="auto">
  <name>Task 2: Export OpenCodeAdapter from platform module</name>
  <files>src/platform/index.ts</files>
  <action>
Add OpenCodeAdapter export to src/platform/index.ts:

Add import and re-export:
```typescript
export { OpenCodeAdapter } from './adapters/opencode';
```

Place near the existing ClaudeCodeAdapter export for consistency.
  </action>
  <verify>
Run: `npm run build && node -e "const p = require('./dist/platform'); console.log('OpenCodeAdapter:', typeof p.OpenCodeAdapter)"`
Expect: Output shows "OpenCodeAdapter: function"
  </verify>
  <done>OpenCodeAdapter exported from src/platform/index.ts</done>
</task>

<task type="auto">
  <name>Task 3: Test OpenCodeAdapter config operations</name>
  <files>(test only - no files modified)</files>
  <action>
Create a quick manual test to verify OpenCodeAdapter works:

```bash
# Create test config directory
mkdir -p /tmp/opencode-test

# Set env var to point to test directory
export XDG_CONFIG_HOME=/tmp/opencode-test

# Run test script
node -e "
const { OpenCodeAdapter } = require('./dist/platform');
const adapter = new OpenCodeAdapter();

(async () => {
  // Test 1: Read non-existent config returns empty object
  const empty = await adapter.readConfig();
  console.log('Empty config:', JSON.stringify(empty));

  // Test 2: Write config
  await adapter.writeConfig({ model: 'test', gsd_installed: true });
  console.log('Config written');

  // Test 3: Read written config
  const config = await adapter.readConfig();
  console.log('Read config:', JSON.stringify(config));

  // Test 4: Merge config
  await adapter.mergeConfig({ new_key: 'value' });
  const merged = await adapter.readConfig();
  console.log('Merged config:', JSON.stringify(merged));

  // Test 5: Path methods
  console.log('Commands dir:', adapter.getCommandsDir());

  console.log('All tests passed!');
})();
"

# Cleanup
rm -rf /tmp/opencode-test
```

Run the test and verify all operations work correctly.
  </action>
  <verify>
Manual test script completes without errors, outputs show:
- Empty config: {}
- Config written
- Read config with gsd_installed: true
- Merged config with both keys
- Commands dir ends with /command/gsd
  </verify>
  <done>OpenCodeAdapter config operations verified working</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` - compiles without errors
2. OpenCodeAdapter is exported from platform module
3. Config read/write works with JSONC parsing
4. Stubbed methods throw clear Phase N error messages
5. Path methods delegate to OpenCodePaths correctly
</verification>

<success_criteria>
- OpenCodeAdapter implements PlatformAdapter interface
- readConfig() uses jsonc-parser to handle comments
- writeConfig() creates JSON file in correct directory
- All stubbed methods throw descriptive "Phase N" errors
- TypeScript build succeeds
- Manual config test passes
</success_criteria>

<output>
After completion, create `.planning/phases/03-opencode-adapter-multi-platform-installation/03-02-SUMMARY.md`
</output>
