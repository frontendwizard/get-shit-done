---
phase: 03-opencode-adapter-multi-platform-installation
plan: 04
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified:
  - bin/install.js
autonomous: true

must_haves:
  truths:
    - "Installer shows multi-select checkbox for platform choice in interactive mode"
    - "Installer accepts --platform flag for non-interactive mode"
    - "Installing for OpenCode creates files in correct directories"
    - "Installing for both platforms creates files in both directories"
    - "Platform-specific backup files created (settings.json.backup, opencode.json.backup)"
  artifacts:
    - path: "bin/install.js"
      provides: "Multi-platform installer with TUI"
      contains: "@inquirer/checkbox"
  key_links:
    - from: "bin/install.js"
      to: "dist/platform/install-adapter"
      via: "getInstallPaths import"
      pattern: "getInstallPaths.*platform"
    - from: "bin/install.js"
      to: "@inquirer/checkbox"
      via: "checkbox import"
      pattern: "checkbox.*@inquirer"
---

<objective>
Add multi-platform selection TUI and --platform flag to installer

Purpose: Users installing GSD can now select Claude Code, OpenCode, or both platforms. Interactive mode shows checkboxes, non-interactive mode uses --platform flag.

Output: Updated install.js with multi-platform support
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-opencode-adapter-multi-platform-installation/03-RESEARCH.md
@.planning/phases/03-opencode-adapter-multi-platform-installation/03-CONTEXT.md
@bin/install.js (current implementation)

Key decisions from CONTEXT.md:
- Multi-select checkboxes for platform choice
- Default behavior: Pre-select NONE (force explicit user choice)
- Non-interactive mode: --platform flag (claude-code | opencode | both), defaults to claude-code
- Platform-specific backup files
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --platform flag parsing and checkbox TUI</name>
  <files>bin/install.js</files>
  <action>
Update bin/install.js with multi-platform support:

**1. Add imports at top of file:**
```javascript
// Dynamic import for ESM module (checkbox is ESM-only)
let checkbox;
async function loadCheckbox() {
  if (!checkbox) {
    const module = await import('@inquirer/checkbox');
    checkbox = module.default;
  }
  return checkbox;
}
```

**2. Add --platform flag parsing near other arg parsing:**
```javascript
// Parse --platform argument
function parsePlatformArg() {
  const platformIndex = args.findIndex(arg => arg === '--platform' || arg === '-p');
  if (platformIndex !== -1) {
    const nextArg = args[platformIndex + 1];
    if (!nextArg || nextArg.startsWith('-')) {
      console.error(`  ${yellow}--platform requires a value (claude-code, opencode, or both)${reset}`);
      process.exit(1);
    }
    return nextArg;
  }
  const platformArg = args.find(arg => arg.startsWith('--platform=') || arg.startsWith('-p='));
  if (platformArg) {
    return platformArg.split('=')[1];
  }
  return null;
}
const explicitPlatform = parsePlatformArg();
```

**3. Add platform selection function:**
```javascript
/**
 * Prompt for platform selection (multi-select checkbox)
 * Returns array of platforms: ['claude-code'] or ['opencode'] or ['claude-code', 'opencode']
 */
async function promptPlatformSelection() {
  // Non-interactive: use flag or default
  if (!process.stdin.isTTY) {
    if (explicitPlatform === 'both') {
      console.log(`  ${yellow}Installing for both platforms (--platform=both)${reset}\n`);
      return ['claude-code', 'opencode'];
    } else if (explicitPlatform === 'opencode') {
      console.log(`  ${yellow}Installing for OpenCode (--platform=opencode)${reset}\n`);
      return ['opencode'];
    } else {
      console.log(`  ${yellow}Non-interactive mode, defaulting to Claude Code${reset}`);
      console.log(`  ${dim}Use --platform=opencode or --platform=both to override${reset}\n`);
      return ['claude-code'];
    }
  }

  // Interactive: show checkbox UI
  const cb = await loadCheckbox();
  console.log(`  ${yellow}Which platform(s) would you like to install for?${reset}\n`);

  const platforms = await cb({
    message: 'Select platform(s):',
    choices: [
      { name: 'Claude Code', value: 'claude-code', checked: false },
      { name: 'OpenCode', value: 'opencode', checked: false }
    ],
    required: true,
    instructions: '(Press space to select, enter to confirm)'
  });

  console.log(''); // Blank line after selection
  return platforms;
}
```

**4. Update help text to include --platform option:**
Add to help section:
```javascript
    ${cyan}-p, --platform <value>${reset}    Platform to install for (claude-code, opencode, or both)
```

And add example:
```javascript
    ${dim}# Install for both platforms${reset}
    npx get-shit-done-cc --global --platform=both
```

**5. Create platform-specific backup function:**
```javascript
/**
 * Create backup of config file before modification
 * Uses platform-specific backup filename
 */
function backupConfigFile(configPath, platform) {
  if (fs.existsSync(configPath)) {
    const backupPath = configPath + '.backup';
    fs.copyFileSync(configPath, backupPath);
    return backupPath;
  }
  return null;
}
```

**6. Update install() function signature:**
Change from `async function install(isGlobal)` to:
```javascript
async function install(isGlobal, platform = 'claude-code')
```

And update the getInstallPaths call:
```javascript
const paths = getInstallPaths(isGlobal, explicitConfigDir, platform);
```

**7. Update main flow to loop over selected platforms:**
In the main async block, after platform selection:
```javascript
const selectedPlatforms = await promptPlatformSelection();

for (const platform of selectedPlatforms) {
  console.log(`\n  Installing for ${cyan}${platform}${reset}...\n`);
  const { settingsPath, settings, statuslineCommand } = await install(isGlobal, platform);

  // Only handle statusline for Claude Code (OpenCode may not support it)
  if (platform === 'claude-code') {
    handleStatusline(settings, process.stdin.isTTY, (shouldInstallStatusline) => {
      finishInstall(settingsPath, settings, statuslineCommand, shouldInstallStatusline);
    });
  } else {
    // OpenCode: just write config and finish
    writeSettings(settingsPath, settings);
    console.log(`\n  ${green}Done!${reset} OpenCode installation complete.\n`);
  }
}
```

**Important notes:**
- Keep backward compatibility: if no --platform flag and interactive mode prompts, user can still choose single platform
- The checkbox requires at least one selection (required: true)
- OpenCode doesn't use statusline hooks (skip that step)
- Each platform gets its own backup file
  </action>
  <verify>
Run: `npm run build` (to ensure TypeScript still compiles)
Then test interactive mode: `node bin/install.js` (should show checkbox)
And non-interactive: `node bin/install.js --global --platform=claude-code`
  </verify>
  <done>install.js updated with multi-platform TUI and --platform flag</done>
</task>

<task type="auto">
  <name>Task 2: Handle OpenCode-specific installation logic</name>
  <files>bin/install.js</files>
  <action>
Add OpenCode-specific handling in the install() function:

**1. Import OpenCodeAdapter:**
```javascript
const { getInstallPaths } = require('../dist/platform/install-adapter');
const { ClaudeCodeAdapter, OpenCodeAdapter } = require('../dist/platform');
```

**2. Create adapter based on platform in install():**
```javascript
// Create adapter for hook registration (platform-specific)
const adapter = platform === 'opencode'
  ? new OpenCodeAdapter()
  : new ClaudeCodeAdapter();
```

**3. Config file path is platform-specific:**
```javascript
// Configure settings/config file path
const configFileName = platform === 'opencode' ? 'opencode.json' : 'settings.json';
const settingsPath = path.join(claudeDir, configFileName);
```

**4. Skip hook registration for OpenCode (Phase 5):**
```javascript
// Register hooks only for Claude Code (OpenCode hooks deferred to Phase 5)
if (platform === 'claude-code') {
  const hasGsdUpdateHook = settings.hooks?.SessionStart?.some(entry =>
    entry.hooks && entry.hooks.some(h => h.command && h.command.includes('gsd-check-update'))
  );

  if (!hasGsdUpdateHook) {
    await adapter.registerHook('SessionStart', updateCheckCommand);
    console.log(`  ${green}âœ“${reset} Configured update check hook`);
  }
}
```

**5. Path replacement for markdown files is platform-specific:**
The pathPrefix from getInstallPaths() should already handle this, but verify the replacement works for both:
- Claude Code: `~/.claude/` or `./.claude/`
- OpenCode: `~/.config/opencode/` or `./.opencode/`

**6. Update cleanup functions to be platform-aware:**
```javascript
// Clean up orphaned files (platform-specific paths)
function cleanupOrphanedFiles(configDir, platform) {
  const orphanedFiles = platform === 'claude-code'
    ? ['hooks/gsd-notify.sh']  // Claude Code specific
    : [];  // No OpenCode orphans yet
  // ... rest of function
}
```
  </action>
  <verify>
Create a test OpenCode installation directory and verify:
```bash
mkdir -p /tmp/opencode-install-test
XDG_CONFIG_HOME=/tmp/opencode-install-test node bin/install.js --global --platform=opencode
ls -la /tmp/opencode-install-test/opencode/
```
Expect: commands/gsd/, opencode.json created
  </verify>
  <done>OpenCode-specific installation logic implemented</done>
</task>

<task type="auto">
  <name>Task 3: Add platform-specific path prefix handling</name>
  <files>bin/install.js</files>
  <action>
Update copyWithPathReplacement() to handle platform-specific path prefixes:

**1. Pass both source prefix and target prefix:**
The function currently replaces `~/.claude/` with pathPrefix. For OpenCode, source markdown files still have `~/.claude/` (since commands are shared), but need to be replaced with OpenCode paths.

Update function signature:
```javascript
function copyWithPathReplacement(srcDir, destDir, pathPrefix) {
  // pathPrefix already contains the correct replacement
  // e.g., '~/.config/opencode/' for OpenCode or '~/.claude/' for Claude Code
  // ...
  content = content.replace(/~\/\.claude\//g, pathPrefix);
  // ...
}
```

The pathPrefix from getInstallPaths() should return the correct prefix for each platform. Verify in install-adapter.ts that:
- Claude Code global: `~/.claude/`
- Claude Code local: `./.claude/`
- OpenCode global: `~/.config/opencode/`
- OpenCode local: `./.opencode/`

**2. Update install-adapter.ts if needed:**
Ensure pathPrefix is set correctly for OpenCode:
```typescript
// For OpenCode
if (platform === 'opencode') {
  return {
    configDir: paths.getConfigDir(),
    commandsDir: paths.getCommandsDir(),
    agentsDir: paths.getAgentsDir(),
    hooksDir: paths.getHooksDir(),
    pathPrefix: isGlobal
      ? '~/.config/opencode/'
      : './.opencode/'
  };
}
```
  </action>
  <verify>
After OpenCode installation, check a command file:
```bash
cat /tmp/opencode-install-test/opencode/command/gsd/help.md | head -20
```
Expect: Path references should use `~/.config/opencode/` not `~/.claude/`
  </verify>
  <done>Path prefix replacement works correctly for both platforms</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Interactive TUI test:
```bash
node bin/install.js
# Should show checkbox with Claude Code and OpenCode options
```

2. Non-interactive test with --platform flag:
```bash
node bin/install.js --global --platform=claude-code 2>&1 | head -20
node bin/install.js --global --platform=opencode 2>&1 | head -20
```

3. OpenCode installation verification:
```bash
XDG_CONFIG_HOME=/tmp/oc-test node bin/install.js --global --platform=opencode
ls /tmp/oc-test/opencode/command/gsd/
cat /tmp/oc-test/opencode/opencode.json
```

4. Backward compatibility (existing --global flag still works):
```bash
node bin/install.js --global
# Should prompt for platform selection
```
</verification>

<success_criteria>
- Interactive mode shows checkbox for platform selection
- Non-interactive mode accepts --platform flag
- Both platforms install to correct directories
- Path prefixes replaced correctly in markdown files
- Platform-specific config files created (settings.json vs opencode.json)
- Hooks only registered for Claude Code (OpenCode deferred)
- Backward compatible with existing installation patterns
</success_criteria>

<output>
After completion, create `.planning/phases/03-opencode-adapter-multi-platform-installation/03-04-SUMMARY.md`
</output>
