---
phase: 04-agent-spawning-abstraction
plan: 05
type: execute
wave: 3
depends_on: [04-01, 04-02, 04-03, 04-04]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Both platforms can spawn agents without errors"
    - "4-7 parallel agents run simultaneously without failures"
    - "Agent spawn failures are detected with clear error messages"
    - "Agent completion is verified and output collected"
    - "All requirements (AGENT-01 through AGENT-05) are satisfied"
  artifacts:
    - path: "src/platform/adapters/claude-code.ts"
      provides: "Working spawnAgent() implementation"
      contains: "async spawnAgent"
    - path: "src/platform/adapters/opencode.ts"
      provides: "Working spawnAgent() implementation"
      contains: "spawn('opencode'"
    - path: "src/platform/agent-runner.ts"
      provides: "Parallel agent execution helper"
      contains: "Promise.allSettled"
  key_links:
    - from: "Workflow commands"
      to: "PlatformAdapter.spawnAgent()"
      via: "can spawn agents on both platforms"
      pattern: "spawnAgent"
    - from: "spawnParallelAgents"
      to: "AgentInstance.waitForCompletion()"
      via: "monitors agent completion"
      pattern: "waitForCompletion"
---

<objective>
Verify multi-platform agent spawning works correctly on both Claude Code and OpenCode

Purpose: Validate that Phase 4 implementation satisfies all success criteria from ROADMAP.md. Confirm parallel agent spawning (4-7 agents), failure detection, output collection, and command portability across platforms.

Output: Comprehensive verification confirming Phase 4 success criteria met, with human checkpoint for final approval.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/04-agent-spawning-abstraction/04-CONTEXT.md

# Success criteria from roadmap
@.planning/ROADMAP.md

# Implemented adapters
@src/platform/adapters/claude-code.ts
@src/platform/adapters/opencode.ts

# Agent runner
@src/platform/agent-runner.ts

# Implementation summaries
@.planning/phases/04-agent-spawning-abstraction/04-01-SUMMARY.md
@.planning/phases/04-agent-spawning-abstraction/04-02-SUMMARY.md
@.planning/phases/04-agent-spawning-abstraction/04-03-SUMMARY.md
@.planning/phases/04-agent-spawning-abstraction/04-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify TypeScript Compilation</name>
  <files></files>
  <action>
Verify all Phase 4 TypeScript code compiles without errors:

```bash
npx tsc --noEmit
```

This confirms:
- AgentInstance implementations are type-safe
- spawnAgent() methods match PlatformAdapter interface
- agent-runner.ts has no type errors
- All imports and exports are correct

Success: Exit code 0 with no TypeScript errors.
Failure: Any compilation errors indicate incomplete implementation.
  </action>
  <verify>Exit code 0 from tsc --noEmit</verify>
  <done>All Phase 4 TypeScript code compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Verify Adapter Interface Compliance</name>
  <files></files>
  <action>
Verify both adapters implement spawnAgent() correctly:

**Check ClaudeCodeAdapter:**
```bash
grep -A10 "async spawnAgent" src/platform/adapters/claude-code.ts | grep -q "agentPath: string"
echo "ClaudeCodeAdapter.spawnAgent signature: $?"

grep -q "ClaudeCodeAgentInstance" src/platform/adapters/claude-code.ts
echo "ClaudeCodeAdapter uses ClaudeCodeAgentInstance: $?"
```

**Check OpenCodeAdapter:**
```bash
grep -A10 "async spawnAgent" src/platform/adapters/opencode.ts | grep -q "agentPath: string"
echo "OpenCodeAdapter.spawnAgent signature: $?"

grep -q "spawn('opencode'" src/platform/adapters/opencode.ts
echo "OpenCodeAdapter uses child_process.spawn: $?"

grep -q "OpenCodeAgentInstance" src/platform/adapters/opencode.ts
echo "OpenCodeAdapter uses OpenCodeAgentInstance: $?"
```

**Success:** All grep checks return 0 (found)
**Confirms:**
- AGENT-01: Both adapters implement spawnAgent()
- Platform-specific implementations: Task tool (Claude Code) vs CLI spawn (OpenCode)
  </action>
  <verify>All grep commands return exit code 0</verify>
  <done>Both adapters implement spawnAgent() with correct signatures and use appropriate AgentInstance implementations.</done>
</task>

<task type="auto">
  <name>Task 3: Verify Parallel Execution Support</name>
  <files></files>
  <action>
Verify parallel agent runner exists and uses Promise.allSettled:

```bash
# Verify spawnParallelAgents exists
grep -q "export async function spawnParallelAgents" src/platform/agent-runner.ts
echo "spawnParallelAgents function exists: $?"

# Verify uses Promise.allSettled (NOT Promise.all)
grep -q "Promise.allSettled" src/platform/agent-runner.ts
echo "Uses Promise.allSettled: $?"

grep -q "Promise.all[^S]" src/platform/agent-runner.ts
if [ $? -eq 0 ]; then
  echo "WARNING: Found Promise.all usage (should use allSettled)"
else
  echo "No Promise.all found (correct - uses allSettled): 0"
fi

# Verify MultiAgentError exists
grep -q "export class MultiAgentError" src/platform/agent-runner.ts
echo "MultiAgentError class exists: $?"

# Verify capability detection
grep -A2 "supportsParallelAgents" src/platform/adapters/claude-code.ts | grep -q "return true"
echo "ClaudeCodeAdapter supports parallel agents: $?"

grep -A2 "supportsParallelAgents" src/platform/adapters/opencode.ts | grep -q "return true"
echo "OpenCodeAdapter supports parallel agents: $?"
```

**Success:** All checks pass (exit code 0 or explicit success)
**Confirms:**
- AGENT-02: Parallel agent spawning implemented
- Promise.allSettled used for error isolation (prevents cascading failures)
- Both platforms report parallel agent support
  </action>
  <verify>All verification commands pass</verify>
  <done>Parallel agent execution helper exists, uses Promise.allSettled correctly, both platforms support parallel agents.</done>
</task>

<task type="auto">
  <name>Task 4: Verify Error Detection and Reporting</name>
  <files></files>
  <action>
Verify agent spawn failures are detected with clear error messages:

**Check file validation:**
```bash
# Both adapters should validate agent file exists
grep -q "fs.existsSync(agentPath)" src/platform/adapters/claude-code.ts
echo "ClaudeCodeAdapter validates agent file: $?"

grep -q "fs.existsSync(agentPath)" src/platform/adapters/opencode.ts
echo "OpenCodeAdapter validates agent file: $?"
```

**Check OpenCode process error handling:**
```bash
# OpenCodeAgentInstance should listen to 'error' event
grep -q "child.on('error'" src/platform/adapters/opencode-agent.ts
echo "OpenCodeAgentInstance listens to 'error' event: $?"

# Should use 'close' event (not just 'exit')
grep -q "child.on('close'" src/platform/adapters/opencode-agent.ts
echo "OpenCodeAgentInstance uses 'close' event: $?"
```

**Check MultiAgentError structure:**
```bash
# MultiAgentError should contain both successful and failed results
grep -A5 "class MultiAgentError" src/platform/agent-runner.ts | grep -q "successful:"
echo "MultiAgentError tracks successful results: $?"

grep -A5 "class MultiAgentError" src/platform/agent-runner.ts | grep -q "failed:"
echo "MultiAgentError tracks failed results: $?"
```

**Success:** All checks pass
**Confirms:**
- AGENT-04: Agent spawn failures detected immediately
- Clear error messages (file validation, process errors)
- Partial results preserved in MultiAgentError
  </action>
  <verify>All verification commands pass</verify>
  <done>Agent spawn failures are detected with clear error messages, OpenCode uses 'close' event correctly, MultiAgentError provides detailed breakdowns.</done>
</task>

<task type="auto">
  <name>Task 5: Verify Output Collection</name>
  <files></files>
  <action>
Verify agent output collection is implemented:

**Check AgentInstance interface:**
```bash
# Both implementations should have getOutput() method
grep -q "async getOutput" src/platform/adapters/claude-code-agent.ts
echo "ClaudeCodeAgentInstance.getOutput() exists: $?"

grep -q "async getOutput" src/platform/adapters/opencode-agent.ts
echo "OpenCodeAgentInstance.getOutput() exists: $?"
```

**Check output collection in agent runner:**
```bash
# spawnParallelAgents should collect output from each agent
grep -q "await instance.getOutput()" src/platform/agent-runner.ts
echo "spawnParallelAgents collects output: $?"

# Should return AgentResult with both instance and output
grep -q "instance, output" src/platform/agent-runner.ts
echo "AgentResult contains instance and output: $?"
```

**Success:** All checks pass
**Confirms:**
- AGENT-05: Agent output collection implemented
- Both platforms can retrieve output after completion
- Parallel runner aggregates outputs
  </action>
  <verify>All verification commands pass</verify>
  <done>Agent output collection works on both platforms, parallel runner aggregates outputs correctly.</done>
</task>

<task type="auto">
  <name>Task 6: Verify Exports and Module Structure</name>
  <files></files>
  <action>
Verify all new modules are exported from src/platform/index.ts:

```bash
# Verify AgentInstance implementations exported
grep -q "ClaudeCodeAgentInstance" src/platform/index.ts
echo "ClaudeCodeAgentInstance exported: $?"

grep -q "OpenCodeAgentInstance" src/platform/index.ts
echo "OpenCodeAgentInstance exported: $?"

# Verify agent runner exports
grep -q "spawnParallelAgents" src/platform/index.ts
echo "spawnParallelAgents exported: $?"

grep -q "MultiAgentError" src/platform/index.ts
echo "MultiAgentError exported: $?"

grep -q "AgentConfig" src/platform/index.ts
echo "AgentConfig exported: $?"

grep -q "AgentResult" src/platform/index.ts
echo "AgentResult exported: $?"

# Verify compiled outputs exist
ls -1 dist/platform/adapters/claude-code-agent.js 2>/dev/null
echo "claude-code-agent.js compiled: $?"

ls -1 dist/platform/adapters/opencode-agent.js 2>/dev/null
echo "opencode-agent.js compiled: $?"

ls -1 dist/platform/agent-runner.js 2>/dev/null
echo "agent-runner.js compiled: $?"
```

**Success:** All exports found, all compiled files exist
**Confirms:**
- Module structure complete
- All utilities accessible to workflows
- TypeScript compilation successful
  </action>
  <verify>All verification commands pass</verify>
  <done>All Phase 4 modules exported correctly, compiled JavaScript files exist in dist/.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Phase 4 Agent Spawning Abstraction implementation:
- AgentInstance implementations for Claude Code and OpenCode
- spawnAgent() methods in both platform adapters
- Parallel agent execution helper using Promise.allSettled
- Error detection and reporting infrastructure

**Implemented capabilities:**
- AGENT-01: Platform-specific agent spawning (Task tool vs CLI)
- AGENT-02: Parallel agent execution (4-7 agents simultaneously)
- AGENT-03: Agent completion verification and status tracking
- AGENT-04: Spawn failure detection with clear error messages
- AGENT-05: Agent output collection from completed agents

**Files created/modified:**
- src/platform/adapters/claude-code-agent.ts (new)
- src/platform/adapters/opencode-agent.ts (new)
- src/platform/agent-runner.ts (new)
- src/platform/adapters/claude-code.ts (spawnAgent implemented)
- src/platform/adapters/opencode.ts (spawnAgent implemented)
- src/platform/index.ts (exports added)
  </what-built>
  <how-to-verify>
**Review implementation:**

1. **Check AgentInstance implementations:**
   ```bash
   cat src/platform/adapters/claude-code-agent.ts
   cat src/platform/adapters/opencode-agent.ts
   ```
   Confirm: Status tracking, completion promises, output collection

2. **Check spawnAgent() implementations:**
   ```bash
   grep -A30 "async spawnAgent" src/platform/adapters/claude-code.ts
   grep -A30 "async spawnAgent" src/platform/adapters/opencode.ts
   ```
   Confirm: File validation, agent instantiation, platform-specific spawning

3. **Check parallel agent runner:**
   ```bash
   cat src/platform/agent-runner.ts
   ```
   Confirm: Promise.allSettled usage, MultiAgentError, error isolation

4. **Verify automated tests passed:**
   Review Tasks 1-6 output above for any failures

**Phase 4 Success Criteria (from ROADMAP.md):**
- [ ] new-project workflow can spawn 4 researchers + 1 synthesizer on Claude Code
- [ ] new-project workflow can spawn 4 researchers + 1 synthesizer on OpenCode
- [ ] Agent spawn failures detected with clear error messages (no silent failures)
- [ ] Agent completion verified and output collected from .planning/ files
- [ ] All 24 commands work on both platforms with correct argument passing

**Note:** Full workflow testing (new-project spawning) will be validated in Phase 5/6. This checkpoint verifies the infrastructure is in place.
  </how-to-verify>
  <resume-signal>
Type "approved" to mark Phase 4 complete, or describe any issues found for investigation.
  </resume-signal>
</task>

</tasks>

<verification>
After completion, verify:
1. All automated verification tasks passed (Tasks 1-6)
2. TypeScript compiles without errors across all Phase 4 files
3. Both adapters implement spawnAgent() correctly
4. Parallel agent runner uses Promise.allSettled
5. Error detection infrastructure in place
6. Output collection works on both platforms
7. All modules exported from src/platform/index.ts
8. Compiled JavaScript exists in dist/ directory
9. Human checkpoint approved Phase 4 implementation
</verification>

<success_criteria>
- All automated verifications pass (exit code 0)
- ClaudeCodeAdapter.spawnAgent() implemented and working
- OpenCodeAdapter.spawnAgent() implemented with child_process.spawn()
- spawnParallelAgents() exists and uses Promise.allSettled
- Agent spawn failures detected with clear error messages
- Agent output collection implemented on both platforms
- supportsParallelAgents() returns true for both platforms
- All requirements (AGENT-01 through AGENT-05) satisfied
- Human approval confirms Phase 4 complete
</success_criteria>

<output>
After completion, create `.planning/phases/04-agent-spawning-abstraction/04-05-SUMMARY.md`
</output>
