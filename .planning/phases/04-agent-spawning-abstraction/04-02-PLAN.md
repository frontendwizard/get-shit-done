---
phase: 04-agent-spawning-abstraction
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/platform/adapters/claude-code.ts
autonomous: true

must_haves:
  truths:
    - "ClaudeCodeAdapter.spawnAgent() can be called without throwing stub error"
    - "Spawned agents return AgentInstance for tracking"
    - "Agent arguments are passed correctly to Task tool invocation"
    - "Spawn failures are detected and reported clearly"
  artifacts:
    - path: "src/platform/adapters/claude-code.ts"
      provides: "spawnAgent() implementation for Claude Code"
      contains: "async spawnAgent(agentPath: string, args"
      min_lines: 180
  key_links:
    - from: "src/platform/adapters/claude-code.ts"
      to: "src/platform/adapters/claude-code-agent.ts"
      via: "instantiates ClaudeCodeAgentInstance"
      pattern: "new ClaudeCodeAgentInstance"
    - from: "src/platform/adapters/claude-code.ts"
      to: "agentPath parameter"
      via: "validates agent file exists"
      pattern: "fs\\.existsSync\\(agentPath\\)"
---

<objective>
Implement spawnAgent() in ClaudeCodeAdapter to enable agent spawning on Claude Code platform

Purpose: Replace the Phase 2 stub with working implementation that leverages Claude Code's Task tool. This makes multi-agent workflows (like new-project with 4 researchers + 1 synthesizer) work on Claude Code.

Output: ClaudeCodeAdapter with functional spawnAgent() method that validates agent files, constructs Task invocations, and returns AgentInstance for tracking.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/04-agent-spawning-abstraction/04-CONTEXT.md
@.planning/phases/04-agent-spawning-abstraction/04-RESEARCH.md

# Interface contract
@src/platform/adapter.ts

# Current adapter (spawnAgent stubbed)
@src/platform/adapters/claude-code.ts

# Research shows Task() usage patterns
@commands/gsd/new-project.md
@commands/gsd/execute-phase.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement spawnAgent() in ClaudeCodeAdapter</name>
  <files>src/platform/adapters/claude-code.ts</files>
  <action>
Replace the spawnAgent() stub with working implementation:

**Current code (line 164):**
```typescript
async spawnAgent(): Promise<AgentInstance> {
  throw new Error('spawnAgent() not implemented in Phase 2 - deferred to Phase 4');
}
```

**New implementation:**
```typescript
async spawnAgent(agentPath: string, args?: Record<string, string>): Promise<AgentInstance> {
  // Validate agent file exists
  if (!fs.existsSync(agentPath)) {
    throw new Error(`Agent file not found: ${agentPath}`);
  }

  // Extract agent name from path for Task invocation
  // Example: /path/to/gsd-project-researcher.md -> gsd-project-researcher
  const agentName = path.basename(agentPath, '.md');

  // Construct prompt from args (if provided)
  let prompt = '';
  if (args && Object.keys(args).length > 0) {
    prompt = Object.entries(args)
      .map(([key, value]) => `${key}: ${value}`)
      .join('\n');
  }

  // Generate unique agent ID for tracking
  const agentId = `${agentName}-${Date.now()}`;

  // Determine output path where agent will write results
  // Agents write to .planning/research/*.md or .planning/phases/*/*.md
  const outputPath = this.determineOutputPath(agentName, args);

  // Create AgentInstance for tracking
  // NOTE: Task tool invocation happens in markdown workflow files
  // This method provides the tracking interface
  const instance = new ClaudeCodeAgentInstance(agentId, outputPath);

  return instance;
}

private determineOutputPath(agentName: string, args?: Record<string, string>): string {
  // Default: .planning/research/{agentName}-output.md
  // Can be overridden by args['output_path'] if provided
  if (args?.output_path) {
    return args.output_path;
  }
  return path.join(process.cwd(), '.planning', 'research', `${agentName}-output.md`);
}
```

**Key insights from research:**
- Task tool is native to Claude Code, invoked in markdown files (see new-project.md lines 334, 373, 412, 451, 494)
- Task() syntax: `Task(prompt="...", subagent_type="agent-name")`
- This TypeScript method provides the tracking interface, not direct Task invocation
- Actual Task calls remain in workflow markdown files
- AgentInstance tracks completion and output collection

**Error handling:**
- Throw if agent file doesn't exist (AGENT-04 requirement)
- Throw if agentPath is malformed

**Imports needed:**
```typescript
import { ClaudeCodeAgentInstance } from './claude-code-agent';
import * as path from 'path';
```

Add imports at top of file, implement method, add private helper.
  </action>
  <verify>
```bash
npx tsc --noEmit
```
Confirms TypeScript compiles without errors and spawnAgent() signature matches PlatformAdapter interface.
  </verify>
  <done>ClaudeCodeAdapter.spawnAgent() implemented, validates agent files, creates ClaudeCodeAgentInstance, determines output paths, compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Update TypeScript Build</name>
  <files>dist/platform/adapters/claude-code.js</files>
  <action>
Compile TypeScript to update dist/ directory with new spawnAgent() implementation:

```bash
npm run build
```

This compiles src/platform/adapters/claude-code.ts to dist/platform/adapters/claude-code.js with the new spawnAgent() method.

Verify compilation succeeds and dist/ contains updated code.
  </action>
  <verify>
```bash
ls -la dist/platform/adapters/claude-code.js
grep -q "spawnAgent" dist/platform/adapters/claude-code.js
echo $?
```
Confirms dist file exists and contains spawnAgent implementation (exit code 0).
  </verify>
  <done>TypeScript compiled successfully, dist/platform/adapters/claude-code.js contains new spawnAgent() implementation.</done>
</task>

</tasks>

<verification>
After completion, verify:
1. spawnAgent() stub replaced with working implementation
2. Method validates agent file existence before proceeding
3. AgentInstance returned for tracking
4. TypeScript compiles without errors
5. dist/ directory updated with compiled code
6. Imports added for ClaudeCodeAgentInstance and path module
</verification>

<success_criteria>
- spawnAgent() no longer throws "not implemented" error
- Method signature matches PlatformAdapter interface
- Agent file validation works (throws clear error if file missing)
- ClaudeCodeAgentInstance instantiated and returned
- Output path determination logic in place
- TypeScript compiles and dist/ updated
</success_criteria>

<output>
After completion, create `.planning/phases/04-agent-spawning-abstraction/04-02-SUMMARY.md`
</output>
