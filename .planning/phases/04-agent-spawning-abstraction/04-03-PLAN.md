---
phase: 04-agent-spawning-abstraction
plan: 03
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - src/platform/adapters/opencode.ts
autonomous: true

must_haves:
  truths:
    - "OpenCodeAdapter.spawnAgent() spawns actual CLI processes"
    - "Agent processes run in background with proper stdio piping"
    - "Spawn failures are detected immediately via 'error' event"
    - "Exit codes distinguish success (0) from failure (non-zero)"
  artifacts:
    - path: "src/platform/adapters/opencode.ts"
      provides: "spawnAgent() implementation with child_process.spawn()"
      contains: "spawn('opencode'"
      min_lines: 200
  key_links:
    - from: "src/platform/adapters/opencode.ts"
      to: "child_process.spawn"
      via: "spawns opencode CLI process"
      pattern: "spawn\\('opencode'"
    - from: "src/platform/adapters/opencode.ts"
      to: "src/platform/adapters/opencode-agent.ts"
      via: "instantiates OpenCodeAgentInstance"
      pattern: "new OpenCodeAgentInstance"
---

<objective>
Implement spawnAgent() in OpenCodeAdapter using Node.js child_process to spawn OpenCode CLI processes

Purpose: Enable multi-agent workflows on OpenCode platform by spawning parallel opencode CLI processes with agent specifications. This completes the cross-platform agent spawning abstraction.

Output: OpenCodeAdapter with functional spawnAgent() that spawns opencode CLI, monitors process lifecycle, and returns AgentInstance for tracking.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/04-agent-spawning-abstraction/04-CONTEXT.md
@.planning/phases/04-agent-spawning-abstraction/04-RESEARCH.md

# Interface contract
@src/platform/adapter.ts

# Current adapter (spawnAgent stubbed)
@src/platform/adapters/opencode.ts

# AgentInstance implementation (created in 04-01)
@src/platform/adapters/opencode-agent.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement spawnAgent() with child_process.spawn()</name>
  <files>src/platform/adapters/opencode.ts</files>
  <action>
Replace the spawnAgent() stub with working implementation using child_process.spawn():

**Current code (line 149):**
```typescript
async spawnAgent(agentPath: string, args?: Record<string, string>): Promise<AgentInstance> {
  throw new Error('spawnAgent() not implemented in Phase 3 - deferred to Phase 4 (Agent Spawning)');
}
```

**New implementation based on research Pattern 1:**
```typescript
import { spawn } from 'child_process';
import { OpenCodeAgentInstance } from './opencode-agent';
import * as path from 'path';

async spawnAgent(agentPath: string, args?: Record<string, string>): Promise<AgentInstance> {
  // Validate agent file exists
  if (!fs.existsSync(agentPath)) {
    throw new Error(`Agent file not found: ${agentPath}`);
  }

  // Extract agent name from path
  // Example: /path/to/gsd-project-researcher.md -> gsd-project-researcher
  const agentName = path.basename(agentPath, '.md');

  // Construct prompt from args
  const prompt = this.constructPrompt(args);

  // Generate unique agent ID
  const agentId = `${agentName}-${Date.now()}`;

  // Spawn opencode CLI process with --agent flag
  // Based on research: use array arguments (NOT shell: true) to prevent injection
  const child = spawn('opencode', [
    '--agent', agentName,
    '--non-interactive',  // Prevent TUI from launching
    prompt
  ], {
    cwd: process.cwd(),
    stdio: ['ignore', 'pipe', 'pipe']  // stdin ignored, capture stdout/stderr
  });

  // Create AgentInstance wrapping the process
  const instance = new OpenCodeAgentInstance(child, agentId);

  return instance;
}

private constructPrompt(args?: Record<string, string>): string {
  if (!args || Object.keys(args).length === 0) {
    return '';
  }

  // Format args as key: value pairs
  return Object.entries(args)
    .map(([key, value]) => `${key}: ${value}`)
    .join('\n');
}
```

**Key decisions from research:**
- Use spawn() not exec() (avoids buffering, safer for large output)
- Array arguments NOT shell: true (prevents shell injection - Pitfall #5)
- stdio: ['ignore', 'pipe', 'pipe'] captures stdout/stderr
- '--non-interactive' flag prevents TUI (per research Open Question #2 - test and adjust if needed)
- OpenCodeAgentInstance handles process monitoring (created in Plan 04-01)

**Error handling:**
- Throw if agent file doesn't exist (AGENT-04)
- OpenCodeAgentInstance 'error' event catches spawn failures (Pitfall #3)

**Imports needed:**
```typescript
import { spawn } from 'child_process';
import { OpenCodeAgentInstance } from './opencode-agent';
import * as path from 'path';
```

Add imports at top of file, implement method, add private helper.
  </action>
  <verify>
```bash
npx tsc --noEmit
```
Confirms TypeScript compiles without errors and spawnAgent() signature matches PlatformAdapter interface.
  </verify>
  <done>OpenCodeAdapter.spawnAgent() implemented with child_process.spawn(), validates agent files, creates OpenCodeAgentInstance, uses array arguments (no shell injection), compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Update Platform Capability Detection</name>
  <files>src/platform/adapters/opencode.ts</files>
  <action>
Update supportsParallelAgents() to return true now that spawnAgent() is implemented:

**Current code (line 122):**
```typescript
supportsParallelAgents(): boolean {
  // To be determined in Phase 4 (Agent Spawning)
  return false;
}
```

**New implementation:**
```typescript
supportsParallelAgents(): boolean {
  // Phase 4: OpenCode supports parallel agents via child_process.spawn()
  // Can spawn multiple opencode CLI processes simultaneously
  return true;
}
```

This signals to workflows that OpenCode now supports multi-agent execution.

Change return value from false to true, update comment.
  </action>
  <verify>
```bash
npx tsc --noEmit
grep -A2 "supportsParallelAgents" src/platform/adapters/opencode.ts
```
Confirms TypeScript compiles and method returns true with updated comment.
  </verify>
  <done>supportsParallelAgents() returns true, indicating OpenCode now supports parallel agent spawning.</done>
</task>

<task type="auto">
  <name>Task 3: Update TypeScript Build</name>
  <files>dist/platform/adapters/opencode.js</files>
  <action>
Compile TypeScript to update dist/ directory with new spawnAgent() implementation:

```bash
npm run build
```

This compiles src/platform/adapters/opencode.ts to dist/platform/adapters/opencode.js with the new spawnAgent() method and capability detection.

Verify compilation succeeds and dist/ contains updated code.
  </action>
  <verify>
```bash
ls -la dist/platform/adapters/opencode.js
grep -q "spawnAgent" dist/platform/adapters/opencode.js
echo $?
```
Confirms dist file exists and contains spawnAgent implementation (exit code 0).
  </verify>
  <done>TypeScript compiled successfully, dist/platform/adapters/opencode.js contains new spawnAgent() implementation and updated capability detection.</done>
</task>

</tasks>

<verification>
After completion, verify:
1. spawnAgent() stub replaced with child_process.spawn() implementation
2. Method validates agent file existence before spawning
3. spawn() uses array arguments (no shell: true) to prevent injection
4. OpenCodeAgentInstance wraps spawned process
5. supportsParallelAgents() returns true
6. TypeScript compiles without errors
7. dist/ directory updated with compiled code
</verification>

<success_criteria>
- spawnAgent() no longer throws "not implemented" error
- Method spawns opencode CLI with --agent and --non-interactive flags
- Array arguments used (NOT shell: true) for security
- Agent file validation works (throws clear error if file missing)
- OpenCodeAgentInstance instantiated and returned
- supportsParallelAgents() returns true
- TypeScript compiles and dist/ updated
</success_criteria>

<output>
After completion, create `.planning/phases/04-agent-spawning-abstraction/04-03-SUMMARY.md`
</output>
