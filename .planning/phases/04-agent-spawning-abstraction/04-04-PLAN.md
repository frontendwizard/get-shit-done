---
phase: 04-agent-spawning-abstraction
plan: 04
type: execute
wave: 2
depends_on: [04-01, 04-02]
files_modified:
  - src/platform/agent-runner.ts
  - src/platform/index.ts
autonomous: true

must_haves:
  truths:
    - "Multiple agents can be spawned in parallel (4-7 simultaneously)"
    - "Partial results collected even when some agents fail"
    - "Failures don't cascade (one agent failure doesn't abort others)"
    - "Clear error reporting distinguishes successful vs failed agents"
  artifacts:
    - path: "src/platform/agent-runner.ts"
      provides: "Parallel agent execution helper using Promise.allSettled"
      exports: ["spawnParallelAgents", "MultiAgentError"]
      min_lines: 80
  key_links:
    - from: "src/platform/agent-runner.ts"
      to: "Promise.allSettled"
      via: "parallel execution with error isolation"
      pattern: "Promise\\.allSettled"
    - from: "src/platform/agent-runner.ts"
      to: "PlatformAdapter.spawnAgent"
      via: "spawns agents via adapter"
      pattern: "adapter\\.spawnAgent"
---

<objective>
Create shared helper for spawning multiple agents in parallel with error isolation and partial result collection

Purpose: Enable multi-agent workflows (like new-project with 4 researchers + 1 synthesizer) to spawn agents concurrently, collect all results even if some fail, and provide clear error reporting. This is the final piece for AGENT-02 (parallel spawning) and AGENT-04 (failure detection).

Output: agent-runner.ts utility with spawnParallelAgents() function using Promise.allSettled pattern from research.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/04-agent-spawning-abstraction/04-CONTEXT.md
@.planning/phases/04-agent-spawning-abstraction/04-RESEARCH.md

# Interface contract
@src/platform/adapter.ts

# Adapter implementations (spawnAgent now working)
@src/platform/adapters/claude-code.ts
@src/platform/adapters/opencode.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Parallel Agent Runner</name>
  <files>src/platform/agent-runner.ts</files>
  <action>
Create agent-runner.ts with spawnParallelAgents() function based on research Pattern 2:

**Implementation:**
```typescript
import { PlatformAdapter, AgentInstance } from './adapter';

/**
 * Configuration for a single agent to spawn
 */
export interface AgentConfig {
  /** Absolute path to agent markdown file */
  path: string;
  /** Optional arguments to pass to agent */
  args?: Record<string, string>;
}

/**
 * Result from a completed agent
 */
export interface AgentResult {
  /** Agent instance that completed */
  instance: AgentInstance;
  /** Output from agent */
  output: string;
}

/**
 * Error thrown when one or more agents fail
 * Contains both successful results and failure reasons
 */
export class MultiAgentError extends Error {
  constructor(
    message: string,
    public readonly successful: AgentResult[],
    public readonly failed: Array<{ config: AgentConfig; error: Error }>
  ) {
    super(message);
    this.name = 'MultiAgentError';
  }
}

/**
 * Spawn multiple agents in parallel using Promise.allSettled pattern
 *
 * Key behaviors (from research):
 * - All agents spawn simultaneously (not sequential)
 * - Waits for ALL agents to complete (doesn't fail fast)
 * - Collects both successes and failures
 * - Returns successful results even if some agents fail
 * - Throws MultiAgentError with detailed breakdown if any fail
 *
 * @param adapter - Platform adapter to use for spawning
 * @param agentConfigs - Array of agent configurations to spawn
 * @returns Promise resolving to array of successful agent results
 * @throws MultiAgentError if any agents fail (includes partial results)
 */
export async function spawnParallelAgents(
  adapter: PlatformAdapter,
  agentConfigs: AgentConfig[]
): Promise<AgentResult[]> {
  // Spawn all agents in parallel
  const agentPromises = agentConfigs.map(async (config) => {
    const instance = await adapter.spawnAgent(config.path, config.args);
    await instance.waitForCompletion();
    const output = await instance.getOutput();
    return { instance, output, config };
  });

  // Wait for ALL agents to complete (don't fail fast - use allSettled)
  const results = await Promise.allSettled(agentPromises);

  // Separate successes from failures
  const successful: AgentResult[] = [];
  const failed: Array<{ config: AgentConfig; error: Error }> = [];

  results.forEach((result, index) => {
    if (result.status === 'fulfilled') {
      const { instance, output } = result.value;
      successful.push({ instance, output });
    } else {
      failed.push({
        config: agentConfigs[index],
        error: result.reason
      });
    }
  });

  // If any failed, throw MultiAgentError with full breakdown
  if (failed.length > 0) {
    const errorMsg = `${failed.length}/${agentConfigs.length} agents failed`;
    throw new MultiAgentError(errorMsg, successful, failed);
  }

  return successful;
}
```

**Key decisions from research:**
- Promise.allSettled NOT Promise.all (prevents cascading failures - Pitfall #4)
- Return successful results even when some fail (partial result collection - AGENT-05)
- MultiAgentError contains both successes and failures (clear error reporting - AGENT-04)
- All agents spawn simultaneously (parallel execution - AGENT-02)

Create new file with imports, interfaces, class, and function.
  </action>
  <verify>
```bash
npx tsc --noEmit
```
Confirms TypeScript compiles without errors and all types are correctly defined.
  </verify>
  <done>agent-runner.ts created with spawnParallelAgents() function, MultiAgentError class, AgentConfig and AgentResult interfaces, compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Export Agent Runner from Platform Index</name>
  <files>src/platform/index.ts</files>
  <action>
Update src/platform/index.ts to export agent runner utilities:

Add exports:
```typescript
export {
  spawnParallelAgents,
  MultiAgentError,
  AgentConfig,
  AgentResult
} from './agent-runner';
```

This makes the parallel agent runner available to workflows and commands that need to spawn multiple agents.

Place exports in logical grouping (after adapter exports, before path exports).
  </action>
  <verify>
```bash
npx tsc --noEmit
```
Confirms exports are valid and no errors exist.
  </verify>
  <done>src/platform/index.ts exports spawnParallelAgents, MultiAgentError, AgentConfig, and AgentResult, TypeScript compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 3: Update TypeScript Build</name>
  <files>dist/platform/agent-runner.js</files>
  <action>
Compile TypeScript to update dist/ directory with new agent runner:

```bash
npm run build
```

This compiles src/platform/agent-runner.ts to dist/platform/agent-runner.js.

Verify compilation succeeds and dist/ contains the new module.
  </action>
  <verify>
```bash
ls -la dist/platform/agent-runner.js
grep -q "spawnParallelAgents" dist/platform/agent-runner.js
echo $?
```
Confirms dist file exists and contains spawnParallelAgents implementation (exit code 0).
  </verify>
  <done>TypeScript compiled successfully, dist/platform/agent-runner.js contains parallel agent execution utilities.</done>
</task>

</tasks>

<verification>
After completion, verify:
1. agent-runner.ts created with spawnParallelAgents() function
2. MultiAgentError class captures both successes and failures
3. Promise.allSettled used (NOT Promise.all) for error isolation
4. AgentConfig and AgentResult interfaces defined
5. Exports added to src/platform/index.ts
6. TypeScript compiles without errors
7. dist/ directory updated with compiled code
</verification>

<success_criteria>
- spawnParallelAgents() function exists and uses Promise.allSettled
- MultiAgentError provides detailed breakdown of successes and failures
- Function supports 4-7 parallel agents (AGENT-02 requirement)
- Partial results collected even when some agents fail (AGENT-05)
- Clear error reporting distinguishes successful vs failed agents (AGENT-04)
- All utilities exported from src/platform/index.ts
- TypeScript compiles and dist/ updated
</success_criteria>

<output>
After completion, create `.planning/phases/04-agent-spawning-abstraction/04-04-SUMMARY.md`
</output>
