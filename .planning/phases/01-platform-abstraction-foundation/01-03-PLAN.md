---
phase: 01-platform-abstraction-foundation
plan: 03
type: execute
wave: 3
depends_on: [01-02]
files_modified:
  - bin/install.js
  - src/platform/install-adapter.ts
autonomous: true

must_haves:
  truths:
    - Install script uses path resolution abstraction (no hardcoded ~/.claude/)
    - Installation works identically to current behavior on Claude Code
    - Path replacement in markdown files uses runtime-resolved paths
  artifacts:
    - path: src/platform/install-adapter.ts
      provides: Install-time path resolution wrapper
      exports: [getInstallPaths]
      min_lines: 30
    - path: bin/install.js
      provides: Platform-agnostic installation logic
      contains: "require.*platform.*install-adapter"
      min_lines: 570
  key_links:
    - from: bin/install.js
      to: src/platform/install-adapter.ts
      via: requires and calls getInstallPaths()
      pattern: "require.*install-adapter.*getInstallPaths"
    - from: src/platform/install-adapter.ts
      to: src/platform/registry.ts
      via: uses PlatformRegistry.getPathResolver()
      pattern: "PlatformRegistry\\.getPathResolver"
---

<objective>
Integrate path resolution abstraction into install script, replacing hardcoded ~/.claude/ references while maintaining backward compatibility.

Purpose: Make installation platform-agnostic by using PathResolver for directory paths, while preserving existing behavior on Claude Code (zero regression requirement COMPAT-01).

Output: Updated install.js that uses platform abstraction layer for path resolution.
</objective>

<execution_context>
@/Users/juliano.farias/code/github/get-shit-done/.claude/get-shit-done/workflows/execute-plan.md
@/Users/juliano.farias/code/github/get-shit-done/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/juliano.farias/code/github/get-shit-done/.planning/PROJECT.md
@/Users/juliano.farias/code/github/get-shit-done/.planning/ROADMAP.md
@/Users/juliano.farias/code/github/get-shit-done/.planning/STATE.md
@/Users/juliano.farias/code/github/get-shit-done/.planning/REQUIREMENTS.md
@/Users/juliano.farias/code/github/get-shit-done/.planning/phases/01-platform-abstraction-foundation/01-RESEARCH.md
@/Users/juliano.farias/code/github/get-shit-done/bin/install.js

Dependencies:
- Requires src/platform/registry.ts from Plan 02
- Requires src/platform/paths.ts from Plan 02

Current install.js behavior (lines 246-296):
- Derives claudeDir from CLAUDE_CONFIG_DIR env var or ~/.claude
- Creates commandsDir as {claudeDir}/commands
- Creates gsdDest as {commandsDir}/gsd
- Uses pathPrefix for markdown file replacement (either ~/.claude/ or ./.claude/)

Target: Replace hardcoded path logic with PathResolver calls while maintaining identical behavior.
</context>

<tasks>

<task type="auto">
  <name>Create install-time path adapter</name>
  <files>src/platform/install-adapter.ts</files>
  <action>
Create src/platform/install-adapter.ts providing install-specific path utilities.

Export getInstallPaths(isGlobal, explicitConfigDir) function:
- Import PlatformRegistry from ./registry
- Import PathResolver from ./paths
- Parameters: isGlobal (boolean), explicitConfigDir (string | null)
- Returns object: { configDir, commandsDir, agentsDir, hooksDir, pathPrefix }

Logic:
1. If NOT isGlobal (local install):
   - configDir = {cwd}/.claude
   - pathPrefix = './.claude/'
   - Return early (local install doesn't use platform detection)

2. If isGlobal:
   - Get resolver from PlatformRegistry.getPathResolver()
   - configDir = explicitConfigDir ? expandTilde(explicitConfigDir) : resolver.getConfigDir()
   - commandsDir = resolver.getCommandsDir()
   - agentsDir = resolver.getAgentsDir()
   - hooksDir = resolver.getHooksDir()
   - pathPrefix = explicitConfigDir ? `${configDir}/` : (use ~ shorthand based on platform)

3. Expand ~ in paths using helper function (copy from install.js lines 96-101)

Return structure should match what install.js currently builds manually (lines 248-264).

Important: For local installs, bypass platform detection entirely (local mode is platform-agnostic, just uses ./.claude/).
  </action>
  <verify>
Create test file test-install-adapter.js:
```javascript
const { getInstallPaths } = require('./src/platform/install-adapter');
const global = getInstallPaths(true, null);
const local = getInstallPaths(false, null);
console.log('Global paths:', global);
console.log('Local paths:', local);
console.log('Test passed');
```
Run: `node test-install-adapter.js` - should print paths for both modes
  </verify>
  <done>getInstallPaths() function exists and returns platform-appropriate paths for global/local installation</done>
</task>

<task type="auto">
  <name>Refactor install.js to use path abstraction</name>
  <files>bin/install.js</files>
  <action>
Modify bin/install.js to use platform abstraction while maintaining backward compatibility.

Changes to install() function (lines 246-412):

1. Add require at top:
```javascript
const { getInstallPaths } = require('../src/platform/install-adapter');
```

2. Replace lines 248-264 (path derivation) with:
```javascript
const paths = getInstallPaths(isGlobal, explicitConfigDir);
const { configDir, commandsDir, agentsDir, hooksDir, pathPrefix } = paths;
const claudeDir = configDir;  // Alias for backward compat with existing code
```

3. Remove manual path construction - now comes from getInstallPaths()

4. Keep all other logic identical:
- locationLabel calculation (lines 256-258)
- Clean install directory removal (lines 130-133)
- Copy operations with path replacement (lines 278-328)
- Settings.json manipulation (lines 377-411)
- Verification (lines 215-242)

Do NOT change:
- Banner, arg parsing, help text (lines 1-91)
- copyWithPathReplacement logic (lines 128-152) - still needed for markdown files
- cleanupOrphanedFiles, cleanupOrphanedHooks (lines 157-210)
- verifyInstalled helpers (lines 214-242)
- handleStatusline, finishInstall, promptLocation (lines 413-569)

Rationale: Minimize changes. Only replace hardcoded path derivation with platform abstraction. All other logic remains identical to ensure zero regression.

Test points:
- Global install to ~/.claude/ should work identically to before
- Local install to ./.claude/ should work identically to before
- Custom --config-dir should still work
- Markdown file path replacement should still work
  </action>
  <verify>
Test installation (dry-run simulation):
```bash
# Test that install.js loads without syntax errors
node -e "require('./bin/install.js')" || echo "Syntax error"

# Manual test: Run actual install to temp directory
mkdir -p /tmp/test-gsd-install
cd /tmp/test-gsd-install
CLAUDE_CONFIG_DIR=/tmp/test-gsd-install/.claude node /Users/juliano.farias/code/github/get-shit-done/bin/install.js --global --force-statusline

# Verify files installed
ls -la /tmp/test-gsd-install/.claude/commands/gsd/
ls -la /tmp/test-gsd-install/.claude/get-shit-done/
ls -la /tmp/test-gsd-install/.claude/agents/
```
Should install successfully without errors
  </verify>
  <done>install.js uses platform abstraction for path resolution while maintaining identical behavior for Claude Code installations</done>
</task>

</tasks>

<verification>
- [ ] src/platform/install-adapter.ts exists with getInstallPaths export
- [ ] bin/install.js requires install-adapter
- [ ] bin/install.js no longer has hardcoded path derivation logic
- [ ] Installation still works for global mode (test manually)
- [ ] Installation still works for local mode (test manually)
- [ ] Custom --config-dir still works
- [ ] No syntax errors in install.js
</verification>

<success_criteria>
Install script uses platform abstraction:
- getInstallPaths() provides all directory paths for installation
- Hardcoded ~/.claude/ replaced with runtime-resolved paths
- Backward compatibility maintained (Claude Code installations work identically)
- Local installations still work (./.claude/ mode)
- Custom config dir flag still honored
- No regressions in installation behavior
</success_criteria>

<output>
After completion, create `.planning/phases/01-platform-abstraction-foundation/01-03-SUMMARY.md`
</output>
