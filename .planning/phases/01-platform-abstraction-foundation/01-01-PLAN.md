---
phase: 01-platform-abstraction-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/platform/detection.ts
  - src/platform/types.ts
autonomous: true

must_haves:
  truths:
    - Platform can be detected at runtime (Claude Code vs OpenCode vs unknown)
    - Detection respects explicit environment variable override
    - Detection falls back to filesystem probing when env var not set
  artifacts:
    - path: src/platform/detection.ts
      provides: Runtime platform detection logic
      exports: [detectPlatform]
      min_lines: 40
    - path: src/platform/types.ts
      provides: Platform type definitions
      exports: [PlatformType]
      min_lines: 5
  key_links:
    - from: src/platform/detection.ts
      to: filesystem (os.homedir, fs.existsSync)
      via: probing for config files
      pattern: "fs\\.existsSync.*\\.claude|opencode"
---

<objective>
Create runtime platform detection that identifies which AI platform (Claude Code or OpenCode) GSD is running on.

Purpose: Enable platform-agnostic business logic by detecting the execution environment at runtime, supporting both explicit configuration (GSD_PLATFORM env var) and automatic detection (filesystem probing).

Output: TypeScript modules for platform detection with priority-based resolution (env var > marker file > filesystem probe).
</objective>

<execution_context>
@/Users/juliano.farias/code/github/get-shit-done/.claude/get-shit-done/workflows/execute-plan.md
@/Users/juliano.farias/code/github/get-shit-done/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/juliano.farias/code/github/get-shit-done/.planning/PROJECT.md
@/Users/juliano.farias/code/github/get-shit-done/.planning/ROADMAP.md
@/Users/juliano.farias/code/github/get-shit-done/.planning/STATE.md
@/Users/juliano.farias/code/github/get-shit-done/.planning/REQUIREMENTS.md
@/Users/juliano.farias/code/github/get-shit-done/.planning/phases/01-platform-abstraction-foundation/01-RESEARCH.md

Current codebase: JavaScript (Node.js 16.7.0+), zero dependencies approach
Target: Add TypeScript files alongside existing JS (no migration yet)
</context>

<tasks>

<task type="auto">
  <name>Create platform type definitions</name>
  <files>src/platform/types.ts</files>
  <action>
Create src/platform/types.ts defining PlatformType as union type:

```typescript
export type PlatformType = 'claude-code' | 'opencode' | 'unknown';
```

Keep minimal - only type definitions, no implementation. This supports detection.ts without coupling to future adapter interface.
  </action>
  <verify>File exists at src/platform/types.ts and exports PlatformType</verify>
  <done>PlatformType type definition exists and can be imported</done>
</task>

<task type="auto">
  <name>Implement platform detection with priority-based resolution</name>
  <files>src/platform/detection.ts</files>
  <action>
Create src/platform/detection.ts implementing detectPlatform() function per RESEARCH.md Pattern 2 (Factory Registry with Runtime Detection).

Priority order (highest to lowest):
1. GSD_PLATFORM environment variable ('claude-code' | 'opencode')
2. .platform marker file (created by installer to persist choice)
3. Filesystem probing (check for ~/.claude/settings.json or ~/.config/opencode/opencode.json)
4. Ambiguity handling (if both platforms detected, return 'unknown' with warning)

Implementation requirements:
- Import PlatformType from ./types
- Use Node.js stdlib only: fs, path, os (zero dependencies)
- Return 'claude-code' if ~/.claude/settings.json exists
- Return 'opencode' if ~/.config/opencode/opencode.json exists
- Return 'unknown' if neither or both detected
- Log warning to console.warn when both platforms found (user should set GSD_PLATFORM)
- Expand ~ in paths using os.homedir()

Do NOT check for platform capabilities or version - just detect which platform is present.

Reference implementation pattern from RESEARCH.md lines 444-492 (Runtime Platform Detection example).
  </action>
  <verify>
Run test: `node -e "const d = require('./src/platform/detection.ts'); console.log(d.detectPlatform())"`
Should output: 'claude-code' (since ~/.claude exists in current dev environment)
  </verify>
  <done>detectPlatform() function exists, returns correct PlatformType based on environment, and handles all priority levels</done>
</task>

</tasks>

<verification>
- [ ] src/platform/types.ts exists and exports PlatformType
- [ ] src/platform/detection.ts exists and exports detectPlatform
- [ ] detectPlatform() returns 'claude-code' in current environment
- [ ] Code uses only Node.js stdlib (no external dependencies)
- [ ] Detection logic matches priority order from research
</verification>

<success_criteria>
Platform detection works correctly:
- Explicit GSD_PLATFORM env var overrides filesystem probing
- Filesystem probing detects Claude Code when ~/.claude/settings.json exists
- Filesystem probing detects OpenCode when ~/.config/opencode/opencode.json exists
- Returns 'unknown' with warning when both platforms detected
- No external dependencies introduced
</success_criteria>

<output>
After completion, create `.planning/phases/01-platform-abstraction-foundation/01-01-SUMMARY.md`
</output>
