---
phase: 06-testing-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vitest.config.ts
  - package.json
  - tsconfig.json
  - tests/__mocks__/fs.cjs
  - tests/__mocks__/fs/promises.cjs
autonomous: true

must_haves:
  truths:
    - "npm test runs Vitest without errors"
    - "npm test:coverage generates coverage report"
    - "Tests can mock filesystem without touching real disk"
  artifacts:
    - path: "vitest.config.ts"
      provides: "Vitest configuration for TypeScript + CommonJS"
      contains: "defineConfig"
    - path: "tests/__mocks__/fs.cjs"
      provides: "memfs mock for node:fs"
      contains: "memfs"
    - path: "tests/__mocks__/fs/promises.cjs"
      provides: "memfs mock for node:fs/promises"
      contains: "memfs"
  key_links:
    - from: "vitest.config.ts"
      to: "tsconfig.json"
      via: "TypeScript resolver"
      pattern: "include.*tests"
---

<objective>
Set up Vitest testing infrastructure with memfs for filesystem mocking.

Purpose: Establish foundation for all Phase 6 tests with zero-config TypeScript support and in-memory filesystem operations.
Output: Working `npm test` command, coverage reporting, and fs mocks ready for use.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-testing-validation/06-RESEARCH.md
@package.json
@tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Vitest and memfs dependencies</name>
  <files>package.json</files>
  <action>
Install Vitest testing framework and memfs filesystem mocking library as dev dependencies:

```bash
npm install -D vitest @vitest/coverage-v8 memfs @vitest/ui
```

This adds:
- vitest: Test runner with native TypeScript support
- @vitest/coverage-v8: V8-based code coverage (faster than istanbul)
- memfs: In-memory filesystem for mocking fs operations
- @vitest/ui: Visual UI for debugging tests (optional but helpful)

Do NOT install @types packages - Vitest includes its own types.
  </action>
  <verify>Check package.json devDependencies include vitest, @vitest/coverage-v8, memfs, @vitest/ui</verify>
  <done>All testing dependencies installed in devDependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create Vitest configuration</name>
  <files>vitest.config.ts, tsconfig.json</files>
  <action>
Create `vitest.config.ts` at project root:

```typescript
import { defineConfig } from 'vitest/config';

export default defineConfig({
  test: {
    globals: true,
    environment: 'node',
    include: ['tests/**/*.test.ts'],
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      include: ['src/**/*.ts'],
      exclude: ['src/**/*.d.ts', 'src/**/index.ts'],
    },
    mockReset: true,
    restoreMocks: true,
  },
});
```

Update `tsconfig.json` to include test types:
1. Add `"vitest/globals"` to compilerOptions.types array
2. Update include to add `"tests/**/*"`

The existing tsconfig.json has:
- types: ["node"]

Change to:
- types: ["node", "vitest/globals"]
- include: ["src/**/*", "tests/**/*"]
  </action>
  <verify>vitest.config.ts exists and tsconfig.json has vitest/globals in types</verify>
  <done>Vitest configured for TypeScript with global test functions</done>
</task>

<task type="auto">
  <name>Task 3: Create memfs mocks and test scripts</name>
  <files>tests/__mocks__/fs.cjs, tests/__mocks__/fs/promises.cjs, package.json</files>
  <action>
Create directory structure:
```
tests/
  __mocks__/
    fs.cjs
    fs/
      promises.cjs
```

Create `tests/__mocks__/fs.cjs`:
```javascript
const { fs } = require('memfs');
module.exports = fs;
```

Create `tests/__mocks__/fs/promises.cjs`:
```javascript
const { fs } = require('memfs');
module.exports = fs.promises;
```

Note: Using .cjs extension because memfs exports CommonJS and Vitest needs CommonJS mocks.

Add test scripts to package.json:
```json
{
  "scripts": {
    "test": "vitest",
    "test:run": "vitest run",
    "test:coverage": "vitest run --coverage",
    "test:ui": "vitest --ui"
  }
}
```

Keep existing scripts (build, watch, clean).
  </action>
  <verify>
Run `npm test -- --run` to verify Vitest starts (will show 0 tests found - that's expected).
Verify mock files exist at tests/__mocks__/fs.cjs and tests/__mocks__/fs/promises.cjs.
  </verify>
  <done>memfs mocks created and npm test script runs Vitest</done>
</task>

</tasks>

<verification>
1. `npm test -- --run` executes without errors (shows "no test files found" is OK)
2. `npm run test:coverage` executes without errors
3. Package.json has vitest, memfs in devDependencies
4. vitest.config.ts exists with correct configuration
5. tsconfig.json includes vitest/globals type
6. tests/__mocks__/fs.cjs exists
7. tests/__mocks__/fs/promises.cjs exists
</verification>

<success_criteria>
- Vitest testing infrastructure is installed and configured
- Test scripts are added to package.json
- memfs mocks are in place for filesystem isolation
- Running `npm test` starts Vitest without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-testing-validation/06-01-SUMMARY.md`
</output>
