---
phase: 02-claude-code-adapter-backward-compatibility
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/install.js
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Configuration backup is created before settings.json modification"
    - "User can recover from bad installation via backup file"
  artifacts:
    - path: "bin/install.js"
      provides: "Backup creation before config modification"
      contains: "settings.json.backup"
  key_links:
    - from: "install()"
      to: "settings.json.backup"
      via: "fs.copyFileSync before first modification"
      pattern: "copyFileSync.*settings\\.json.*backup"
---

<objective>
Add configuration backup mechanism before modifying settings.json

Purpose: INST-05 requires configuration backup before modification. Currently neither the adapter nor install.js creates a backup, leaving users without recovery option if installation corrupts settings.

Output: install.js creates settings.json.backup before any modifications to settings.json
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Gap being closed
@.planning/phases/02-claude-code-adapter-backward-compatibility/02-VERIFICATION.md

# Requirement reference
INST-05: Configuration backup before modification
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add backup creation helper function</name>
  <files>bin/install.js</files>
  <action>
Add a new helper function after the readSettings/writeSettings functions (around line 125):

```javascript
/**
 * Create backup of settings.json before modification
 * Backup is overwritten on each install (single recovery point)
 */
function backupSettings(settingsPath) {
  if (fs.existsSync(settingsPath)) {
    const backupPath = settingsPath + '.backup';
    fs.copyFileSync(settingsPath, backupPath);
    return backupPath;
  }
  return null;
}
```

This is a simple copy operation - no timestamp, no versioning.
- Only backs up if settings.json exists (no error on fresh install)
- Returns backup path for logging, or null if no backup created
  </action>
  <verify>
`grep -A8 "function backupSettings" bin/install.js` shows the function
  </verify>
  <done>backupSettings() function exists in install.js</done>
</task>

<task type="auto">
  <name>Task 2: Call backup before first settings modification</name>
  <files>bin/install.js</files>
  <action>
In the install() function, add backup call BEFORE line 370 (where settings is first read for modification).

Find this section (around line 368-370):
```javascript
  // Configure statusline and hooks in settings.json
  const settingsPath = path.join(claudeDir, 'settings.json');
  const settings = cleanupOrphanedHooks(readSettings(settingsPath));
```

Change to:
```javascript
  // Configure statusline and hooks in settings.json
  const settingsPath = path.join(claudeDir, 'settings.json');

  // Backup existing settings before any modifications (INST-05)
  const backupPath = backupSettings(settingsPath);
  if (backupPath) {
    console.log(`  ${green}âœ“${reset} Backed up settings.json`);
  }

  const settings = cleanupOrphanedHooks(readSettings(settingsPath));
```

Key points:
- Backup happens BEFORE cleanupOrphanedHooks (first modification)
- Only logs if backup was actually created (not on fresh install)
- Uses existing green checkmark pattern for consistency
  </action>
  <verify>
1. `grep -B2 -A4 "backupSettings(settingsPath)" bin/install.js` shows backup call before settings read
2. `grep "Backed up settings.json" bin/install.js` confirms log message exists
3. `node --check bin/install.js` exits 0
  </verify>
  <done>
Backup is created before any settings.json modification, with user-visible confirmation
  </done>
</task>

</tasks>

<verification>
After task completion:
1. Function exists: backupSettings() defined in install.js
2. Called correctly: backup happens before cleanupOrphanedHooks()
3. Syntax valid: `node --check bin/install.js` succeeds
4. Logic correct: Backup only created if settings.json exists (no error on fresh install)
</verification>

<success_criteria>
- INST-05 requirement satisfied: configuration backup exists before modification
- settings.json.backup created in same directory as settings.json
- User sees "Backed up settings.json" during installation (if settings existed)
- Fresh installs work without error (no settings to back up)
</success_criteria>

<output>
After completion, create `.planning/phases/02-claude-code-adapter-backward-compatibility/02-05-SUMMARY.md`
</output>
