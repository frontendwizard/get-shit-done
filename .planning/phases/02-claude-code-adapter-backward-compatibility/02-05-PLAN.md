---
phase: 02-claude-code-adapter-backward-compatibility
plan: 05
type: execute
wave: 4
depends_on: [02-02, 02-03, 02-04]
files_modified: []
autonomous: false

must_haves:
  truths:
    - User can upgrade from v1.x without migration
    - Active projects continue working after upgrade
    - Commands execute without errors
    - Settings format is preserved (hooks, formatting, structure identical to v1.x)
    - Adapter methods are invoked during installation (not just syntax)
  artifacts:
    - path: ~/.claude/settings.json
      provides: Properly formatted settings with GSD hooks
      contains: "gsd-check-update.js"
    - path: ~/.claude/commands/gsd/execute-phase.md
      provides: Installed command with rendered paths (no {{config_dir}})
      contains: "@~/.claude/get-shit-done/"
  key_links:
    - from: ~/.claude/settings.json
      to: ~/.claude/hooks/gsd-check-update.js
      via: "SessionStart hook registration"
      pattern: "gsd-check-update"
    - from: ~/.claude/commands/gsd/*.md
      to: ~/.claude/get-shit-done/
      via: "@~/.claude/get-shit-done/ references"
      pattern: "@~/.claude/get-shit-done/"
---

<objective>
Verify ClaudeCodeAdapter implementation and install.js refactoring preserve exact v1.x behavior with zero regression.

Purpose: Confirm existing GSD users can upgrade seamlessly, all commands work identically, and no manual migration is required.

Output: Verified working installation with documented test results
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-claude-code-adapter-backward-compatibility/02-CONTEXT.md

# All prior plans
@.planning/phases/02-claude-code-adapter-backward-compatibility/02-01-SUMMARY.md
@.planning/phases/02-claude-code-adapter-backward-compatibility/02-02-SUMMARY.md
@.planning/phases/02-claude-code-adapter-backward-compatibility/02-03-SUMMARY.md
@.planning/phases/02-claude-code-adapter-backward-compatibility/02-04-SUMMARY.md

# Test against current implementation
@bin/install.js
@src/platform/adapters/claude-code.ts
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 2 implementation:
- ClaudeCodeAdapter with config, hook, and command management
- Refactored install.js using adapter pattern
- Platform-agnostic command files with {{config_dir}} placeholders
- Template rendering in copyWithPathReplacement

Changes span:
- src/platform/adapters/claude-code.ts (new, ~350 lines)
- src/platform/registry.ts (createAdapter factory added)
- bin/install.js (refactored to use adapter)
- commands/gsd/*.md (24 files, path placeholders)
  </what-built>

  <how-to-verify>
**Pre-verification checks:**

1. **Build verification:**
```bash
npm run build
# Should compile without errors

node -e "const {ClaudeCodeAdapter} = require('./dist/platform/adapters/claude-code'); const a = new ClaudeCodeAdapter(); console.log('Adapter:', a.name, 'Version:', a.version);"
# Should output: Adapter: claude-code Version: <package version>
```

2. **Command file verification:**
```bash
# Verify source files have placeholders
grep -l "{{config_dir}}" commands/gsd/*.md | wc -l
# Should be 15-20 files

# Verify no hardcoded paths in source
! grep "@~/.claude/get-shit-done/" commands/gsd/*.md
# Should succeed (no matches)
```

**Installation test (clean environment):**

3. **Backup existing installation:**
```bash
# If you have existing GSD installation, backup first
mv ~/.claude/settings.json ~/.claude/settings.json.pre-phase2
mv ~/.claude/commands/gsd ~/.claude/commands/gsd.pre-phase2
mv ~/.claude/hooks/gsd-* ~/.claude/hooks/gsd-backup/
```

4. **Test fresh installation:**
```bash
# Install from working directory
npm run build
node bin/install.js --global

# Verify installation success
ls -la ~/.claude/commands/gsd/
ls -la ~/.claude/hooks/
cat ~/.claude/settings.json
```

5. **Verify settings.json format:**
```bash
cat ~/.claude/settings.json | jq .

# Check hooks structure:
# - Should have hooks.SessionStart array
# - Should have hooks.StatusLine array (if not skipped)
# - Each hook entry should have {hooks: [{type: 'command', command: '...'}]} structure
# - No duplicate GSD hooks

# Verify backup created:
ls -la ~/.claude/settings.json.backup
```

6. **Verify installed commands have rendered paths:**
```bash
# Check that {{config_dir}} was replaced
! grep "{{config_dir}}" ~/.claude/commands/gsd/execute-phase.md
# Should succeed (no placeholders)

# Check that paths are correct
grep "@~/.claude/get-shit-done/" ~/.claude/commands/gsd/execute-phase.md
# Should find actual paths
```

7. **Test command execution in Claude Code:**

Create a test .planning/ project or use this existing GSD project:

```
/gsd:help
# Should display help without errors

/gsd:progress
# Should show current project state (this GSD project)

/gsd:debug
# Should show environment info, verify paths are correct
```

8. **Verify hooks execute:**

Restart Claude Code, then:
```bash
# Check that gsd-check-update.js ran (SessionStart hook)
# Look for update check output in Claude Code console/logs

# Verify status line shows (if StatusLine hook installed)
# Should see GSD phase/plan context in status line
```

**Upgrade test (existing installation):**

9. **Test upgrade scenario:**
```bash
# Restore pre-phase2 backup
mv ~/.claude/settings.json.pre-phase2 ~/.claude/settings.json

# Add some custom settings to test merge
cat ~/.claude/settings.json | jq '. + {customSetting: "test"}' > ~/.claude/settings.json.tmp
mv ~/.claude/settings.json.tmp ~/.claude/settings.json

# Run installation (should merge, not replace)
node bin/install.js --global

# Verify custom settings preserved
cat ~/.claude/settings.json | jq .customSetting
# Should output: "test"

# Verify GSD hooks added
cat ~/.claude/settings.json | jq '.hooks.SessionStart'
# Should include gsd-check-update.js

# Verify backup created
ls -la ~/.claude/settings.json.backup
```

10. **Test active project compatibility:**

If you have a .planning/ directory in a test project:
```bash
cd /path/to/test/project/with/.planning

# Run a GSD command
claude "/gsd:progress"

# Verify it works without modification to .planning/ files
# No migration should be needed
```

11. **Integration test - adapter method invocation:**

Add test instrumentation to verify adapter methods are actually called during installation:

```bash
# Create test wrapper that logs adapter calls
cat > test-install.js << 'EOF'
const Module = require('module');
const originalRequire = Module.prototype.require;

const methodsCalled = [];

Module.prototype.require = function(id) {
  const module = originalRequire.apply(this, arguments);

  if (id.includes('platform/registry')) {
    const originalCreateAdapter = module.createAdapter;
    module.createAdapter = function() {
      const adapter = originalCreateAdapter.apply(this, arguments);

      // Wrap registerHook to track calls
      const originalRegisterHook = adapter.registerHook.bind(adapter);
      adapter.registerHook = async function(...args) {
        methodsCalled.push('registerHook: ' + args[0]);
        return originalRegisterHook(...args);
      };

      return adapter;
    };
  }

  return module;
};

// Run install (would need to mock file system for full test)
console.log('Integration test: Verify adapter.registerHook called during install');
console.log('This is validated in human verification step 4-8');
EOF

# Note: Full integration test requires complex mocking
# Human verification steps 4-8 provide functional confirmation
```

**Success criteria:**
- [ ] Build succeeds without TypeScript errors
- [ ] Fresh installation succeeds
- [ ] settings.json format matches v1.x (verified via jq)
- [ ] Hooks registered correctly
- [ ] Backup created before modification
- [ ] Installed commands have rendered paths (no {{config_dir}})
- [ ] All commands execute in Claude Code
- [ ] Upgrade preserves existing settings
- [ ] Active .planning/ projects work unchanged
- [ ] No regression in command behavior
- [ ] Adapter methods confirmed invoked during installation (steps 4-8 validate)
  </how-to-verify>

  <resume-signal>
Reply with one of:

**approved** - All verification steps passed, no regressions found

**issues: <description>** - Verification revealed problems:
  - settings.json format changed
  - Commands don't execute
  - Template rendering incomplete
  - Other regression

**partial: <description>** - Most tests passed but minor issues:
  - Describe what needs fixing
  - Note if issues are blockers or cosmetic
  </resume-signal>
</task>

</tasks>

<verification>
This entire plan IS the verification - checkpoint validates Phase 2 implementation.

After human approval, document results in SUMMARY.md.
</verification>

<success_criteria>
- [ ] Human verified fresh installation works correctly
- [ ] Human verified upgrade preserves existing settings
- [ ] Human verified commands execute identically to v1.x
- [ ] Human verified settings.json format unchanged
- [ ] Human verified installed commands have rendered paths
- [ ] Human verified active .planning/ projects continue working
- [ ] Human verified adapter methods invoked during installation (via functional test)
- [ ] No regressions reported
</success_criteria>

<output>
After human approval, create `.planning/phases/02-claude-code-adapter-backward-compatibility/02-05-SUMMARY.md` documenting:
- Verification steps performed
- Test results (pass/fail for each criterion)
- Any issues discovered and resolutions
- Confirmation of backward compatibility
</output>
