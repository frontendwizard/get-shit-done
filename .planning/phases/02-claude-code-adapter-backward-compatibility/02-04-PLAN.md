---
phase: 02-claude-code-adapter-backward-compatibility
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/install.js
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Hook registration via adapter persists after install() completes"
    - "settings.json contains SessionStart hook after full installation"
  artifacts:
    - path: "bin/install.js"
      provides: "Settings re-read after adapter.registerHook()"
      contains: "readSettings(settingsPath)"
  key_links:
    - from: "adapter.registerHook()"
      to: "finishInstall() settings parameter"
      via: "Fresh settings read after hook registration"
      pattern: "settings.*=.*readSettings.*adapter\\.registerHook"
---

<objective>
Fix the hook registration data race in install.js

Purpose: The adapter.registerHook() call writes to settings.json, but install() holds a stale settings object that overwrites the hook when passed to finishInstall(). This causes registered hooks to be lost.

Output: install.js re-reads settings.json after adapter.registerHook() so finishInstall() receives the current state.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Gap being closed
@.planning/phases/02-claude-code-adapter-backward-compatibility/02-VERIFICATION.md

# Prior work context
@.planning/phases/02-claude-code-adapter-backward-compatibility/02-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Re-read settings.json after adapter.registerHook()</name>
  <files>bin/install.js</files>
  <action>
Surgical fix to install.js around lines 383-388:

BEFORE (current code around line 383-388):
```javascript
  if (!hasGsdUpdateHook) {
    await adapter.registerHook('SessionStart', updateCheckCommand);
    console.log(`  ${green}✓${reset} Configured update check hook`);
  }

  return { settingsPath, settings, statuslineCommand };
```

AFTER (with fresh read):
```javascript
  if (!hasGsdUpdateHook) {
    await adapter.registerHook('SessionStart', updateCheckCommand);
    console.log(`  ${green}✓${reset} Configured update check hook`);
  }

  // Re-read settings.json after adapter modifications to avoid data race
  // (adapter.registerHook() writes to disk, we need the updated state)
  const freshSettings = readSettings(settingsPath);

  return { settingsPath, settings: freshSettings, statuslineCommand };
```

Key changes:
1. Add call to readSettings(settingsPath) AFTER the adapter.registerHook() call
2. Return freshSettings instead of stale settings object
3. Add comment explaining WHY (prevent data race)

Do NOT modify any other logic in install.js - this is a surgical fix.
  </action>
  <verify>
1. `grep -A5 "adapter.registerHook" bin/install.js` shows readSettings call after hook registration
2. `grep "freshSettings" bin/install.js` confirms fresh read is returned
3. Node syntax check: `node --check bin/install.js` exits 0
  </verify>
  <done>
install.js returns freshly-read settings object after adapter.registerHook(), ensuring hook registrations persist through finishInstall()
  </done>
</task>

</tasks>

<verification>
After task completion:
1. Manual trace: Line 370 reads settings -> Line 384 adapter writes -> Line ~387 re-reads -> finishInstall gets current state
2. No data race: The settings object passed to finishInstall() contains the hook written by adapter.registerHook()
3. Syntax valid: `node --check bin/install.js` succeeds
</verification>

<success_criteria>
- settings.json hook registration via adapter survives finishInstall()
- install.js has no syntax errors
- Gap "Hook registration modifies settings.json correctly" is closed
</success_criteria>

<output>
After completion, create `.planning/phases/02-claude-code-adapter-backward-compatibility/02-04-SUMMARY.md`
</output>
