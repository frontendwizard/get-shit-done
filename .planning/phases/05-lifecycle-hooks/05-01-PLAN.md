---
phase: 05-lifecycle-hooks
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/platform/adapters/claude-code.ts
  - src/platform/adapters/opencode.ts
autonomous: true

must_haves:
  truths:
    - "ClaudeCodeAdapter.registerHook() is idempotent (multiple calls don't duplicate hooks)"
    - "OpenCodeAdapter.registerHook() returns silently without error (graceful degradation)"
    - "Both adapters compile without TypeScript errors"
  artifacts:
    - path: "src/platform/adapters/claude-code.ts"
      provides: "Idempotent hook registration for Claude Code"
      exports: ["ClaudeCodeAdapter"]
    - path: "src/platform/adapters/opencode.ts"
      provides: "Silent no-op hook registration for OpenCode"
      exports: ["OpenCodeAdapter"]
  key_links:
    - from: "src/platform/adapters/claude-code.ts"
      to: "settings.json hooks array"
      via: "registerHook() method"
      pattern: "registerHook.*HookType.*hookPath"
---

<objective>
Implement adapter-level hook registration with platform-appropriate behavior.

Purpose: Enable cross-platform hook registration where Claude Code gets full functionality and OpenCode gracefully degrades (silent no-op per user decision in CONTEXT.md).

Output: Both adapters implement registerHook() correctly - Claude Code with idempotency, OpenCode with silent skip.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-lifecycle-hooks/05-CONTEXT.md
@.planning/phases/05-lifecycle-hooks/05-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Make ClaudeCodeAdapter.registerHook() idempotent</name>
  <files>src/platform/adapters/claude-code.ts</files>
  <action>
Update ClaudeCodeAdapter.registerHook() to check for existing hook before adding:

1. Before appending to hooks array, check if hook command already exists:
   - Search hooks[hookType] array for any entry where hooks[].command contains the hookPath
   - Use .some() pattern similar to install.js (line 507-509)

2. If hook already exists, return early without modification (idempotent behavior)

3. Keep the existing append logic for when hook doesn't exist

Pattern to match (from install.js):
```typescript
const hasHook = config.hooks?.[hookType]?.some(entry =>
  entry.hooks && entry.hooks.some(h => h.command && h.command.includes(hookPath))
);
if (hasHook) return; // Already registered
```

Do NOT change the hook structure format - it's correct as-is:
```json
{ "hooks": [{ "type": "command", "command": "..." }] }
```
  </action>
  <verify>Run `npm run build` - should compile without errors</verify>
  <done>ClaudeCodeAdapter.registerHook() checks for existing hooks before adding, preventing duplicates</done>
</task>

<task type="auto">
  <name>Task 2: Make OpenCodeAdapter.registerHook() a silent no-op</name>
  <files>src/platform/adapters/opencode.ts</files>
  <action>
Update OpenCodeAdapter.registerHook() to implement graceful degradation per CONTEXT.md decision:

1. Remove the `throw new Error(...)` statement
2. Replace with empty async implementation that returns immediately
3. Add JSDoc comment explaining this is intentional graceful degradation

The method should:
- Accept hookType and hookPath parameters (same signature)
- Do nothing (no logging, no error, no registration)
- Return Promise that resolves immediately

Per user decision in 05-CONTEXT.md:
- "Silent skip when hook not supported - don't register, don't error, don't log"

Also update unregisterHook() with same silent no-op pattern (remove throw, return silently).
  </action>
  <verify>Run `npm run build` - should compile without errors</verify>
  <done>OpenCodeAdapter.registerHook() and unregisterHook() return silently without throwing</done>
</task>

<task type="auto">
  <name>Task 3: Verify TypeScript compilation and exports</name>
  <files>dist/platform/adapters/claude-code.js, dist/platform/adapters/opencode.js</files>
  <action>
Run full build and verify:

1. `npm run build` completes successfully
2. Both adapter files exist in dist/
3. No TypeScript errors related to hook methods
4. Exports are correct (ClaudeCodeAdapter, OpenCodeAdapter)

This confirms the adapters are properly implementing the PlatformAdapter interface.
  </action>
  <verify>Run `npm run build && ls -la dist/platform/adapters/`</verify>
  <done>TypeScript compiles without errors, both adapters exist in dist/ with correct exports</done>
</task>

</tasks>

<verification>
- [ ] `npm run build` succeeds
- [ ] ClaudeCodeAdapter.registerHook() has idempotency check
- [ ] OpenCodeAdapter.registerHook() returns silently (no throw)
- [ ] OpenCodeAdapter.unregisterHook() returns silently (no throw)
- [ ] Both adapters export correctly from dist/
</verification>

<success_criteria>
Adapter hook registration methods are complete:
- Claude Code: Adds hooks to settings.json with deduplication
- OpenCode: Silent no-op (graceful degradation)
Ready for install.js integration in Plan 02.
</success_criteria>

<output>
After completion, create `.planning/phases/05-lifecycle-hooks/05-01-SUMMARY.md`
</output>
